<apex:page standardController="Campaign"
    extensions="ProcessSegmentBTN_CTRL"
    standardStylesheets="false"
    showHeader="True"
    sidebar="False"
    applyBodyTag="False"
    action="{!refreshCampaignList}"
    >

    <body>
        <div class="slds">
            <c:PageMessages />

            <div class="slds-page-header slds-m-bottom--large" role="banner">
                <nav class="slds-m-bottom--xx-small" role="navigation">
                    <p id="bread-crumb-label" class="slds-assistive-text">You are here:</p>
                    <ol class="slds-breadcrumb slds-list--horizontal" aria-labelledby="bread-crumb-label">
                        <li class="slds-list__item slds-text-heading--label">
                            <apex:outputLink value="{!URLFOR($Action.Campaign.Tab, $ObjectType.Campaign)}">
                                <apex:outputText value="{!$ObjectType.Campaign.labelPlural}"/>
                            </apex:outputLink>
                        </li>
                        <li class="slds-list__item slds-text-heading--label">
                            <apex:outputLink value="{!URLFOR($Action.Campaign.View, Campaign.Id)}">
                                <apex:outputText value="{!Campaign.Name}"/>
                            </apex:outputLink>
                        </li>
                    </ol>
                </nav>

                <h1 class="slds-text-heading--medium slds-truncate" title="{!HTMLENCODE($Label.CampaignToolsListRefreshPageTitle)}">
                    <apex:outputText value="{!$Label.CampaignToolsListRefreshPageTitle}"/>
                </h1>
            </div>

            <div class="slds-grid slds-wrap slds-m-vertical--large">
                <div class="slds-col slds-small-size--1-of-1 slds-medium-size--2-of-3 slds-p-horizontal--large slds-m-bottom--large">
                    <div class="slds-card">
                        <div class="slds-card__header slds-grid">
                            <h4 id="update_status_heading" class="slds-text-heading--small"></h4>
                        </div>
                        <div class="slds-card__body slds-p-horizontal--small">
                            <div id="spinner" class="slds-spinner--medium">
                                <img src="{!URLFOR($Resource.LightningDesignSystem, '1_0_2/assets/images/spinners/slds_spinner.gif')}" alt="Loading..." />
                            </div>
                            <p id="update_status_body"></p>
                        </div>
                        <div class="slds-card__footer"></div>
                    </div>

                </div>

                <div class="slds-col slds-small-size--1-of-1 slds-medium-size--1-of-3 slds-p-horizontal--large slds-col-rule--left">
                    <c:JobProgress cNumberOfJobs="4" pollingDelay="10000"/>
                </div>
            </div>

            <script type="text/javascript">
                (function () {
                    var headings = {
                        'processing': '{!JSENCODE($Label.CampaignToolsListRefreshStatusProcessingHeading)}',
                        'completed': '{!JSENCODE($Label.CampaignToolsListRefreshStatusCompletedHeading)}',
                        'failed': '{!JSENCODE($Label.CampaignToolsListRefreshStatusFailedHeading)}',
                        'aborted': '{!JSENCODE($Label.CampaignToolsListRefreshStatusAbortedHeading)}',
                        'queued': '{!JSENCODE($Label.CampaignToolsListRefreshStatusQueuedHeading)}'
                    }

                    var messages = {
                        'processing': '{!JSENCODE($Label.CampaignToolsListRefreshStatusProcessingMessage)}',
                        'queued': '{!JSENCODE($Label.CampaignToolsListRefreshStatusQueuedMessage)}'
                    }

                    var updateStatusHeadingElement = document.getElementById('update_status_heading');
                    var updateStatusBodyElement = document.getElementById('update_status_body');
                    var spinnerElement = document.getElementById('spinner');

                    var updateStatusInterval;

                    function updateStatus() {
                        Visualforce.remoting.Manager.invokeAction(
                            '{!$RemoteAction.ProcessSegmentBTN_CTRL.getCampaignListUpdateStatus}',
                            '{!Campaign.Id}',
                            function (result, event) {
                                if (event.status) {
                                    spinnerElement.setAttribute('class', 'slds-hide');

                                    var status = result.toLowerCase();

                                    var heading = headings[status] || '';
                                    updateStatusHeadingElement.textContent = heading;

                                    var message = messages[status] || '';
                                    updateStatusBodyElement.textContent = message;

                                    if (0 <= ['aborted', 'completed', 'failed'].indexOf(status)) {
                                        window.clearInterval(updateStatusInterval);
                                    }
                                }
                            }
                        );
                    }
                    updateStatus();
                    updateStatusInterval = window.setInterval(updateStatus, 10000);
                })();
            </script>
        </div>
    </body>

    <apex:outputText value="{!Campaign.Name}" rendered="false"/>
    <apex:outputText value="{!Campaign.Campaign_List__c}" rendered="false"/>
</apex:page>